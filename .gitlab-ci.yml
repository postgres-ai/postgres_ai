include:
  - local: 'components/index_pilot/.gitlab-ci.yml'

stages:
  - test
  - publish

reporter:tests:
  stage: test
  image: python:3.11-bullseye
  variables:
    GIT_STRATEGY: fetch
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    PIP_NO_CACHE_DIR: "1"
  before_script:
    - python --version
    - pip install --upgrade pip
    - apt-get update
    - apt-get install -y --no-install-recommends postgresql postgresql-client && rm -rf /var/lib/apt/lists/*
    - pip install -r reporter/requirements-dev.txt
  script:
    - chown -R postgres:postgres "$CI_PROJECT_DIR"
    - su - postgres -c "cd \"$CI_PROJECT_DIR\" && python -m pytest --run-integration tests/reporter"
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:smoke:test:
  stage: test
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - apk add --no-cache bash curl git docker-cli docker-compose
  script:
    - bash -n ./postgres_ai
    - |
      set -euo pipefail
      out=$(./postgres_ai help | tr -d "\r")
      echo "$out" | grep -q "Postgres AI CLI"
      echo "$out" | grep -q "COMMANDS:"
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:e2e:dind:
  stage: test
  image: alpine:3.20
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.43"
    GIT_STRATEGY: fetch
  before_script:
    - apk add --no-cache bash curl git coreutils docker-cli docker-compose openssl
    - docker version
  script:
    - set -euo pipefail
    - bash -n ./postgres_ai
    - ./postgres_ai check || true
    - ./postgres_ai quickstart --demo -y
    - timeout 60 ./postgres_ai status
    - timeout 10 ./postgres_ai logs grafana || true
    - ./postgres_ai config
    - ./postgres_ai update-config
    - ./postgres_ai list-instances || true
    - ./postgres_ai add-key "test_key_123"
    - ./postgres_ai show-key
    - ./postgres_ai remove-key
    - ./postgres_ai generate-grafana-password || true
    - ./postgres_ai show-grafana-credentials || true
    - ./postgres_ai add-instance "postgresql://postgres:postgres@target-db:5432/target_database" "ci-demo"
    - ./postgres_ai test-instance "ci-demo" || true
    - printf "y\n" | ./postgres_ai reset sink-postgres
    - ./postgres_ai restart
    - ./postgres_ai stop
    - ./postgres_ai start
    - printf "y\n" | ./postgres_ai reset
    - ./postgres_ai clean
  after_script:
    - docker ps -a || true
    - docker system prune -af || true
  rules:
    - if: '$CI_COMMIT_BRANCH'
cli:node:smoke:
  stage: test
  image: node:20-alpine
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
  script:
    - node -v && npm -v
    - npm --prefix cli install --no-audit --no-fund
    - node ./cli/dist/bin/postgres-ai.js --help
    - node ./cli/dist/bin/postgres-ai.js mon status --help
    - node ./cli/dist/bin/postgres-ai.js mon targets list --help
    - npm install -g ./cli
    - echo "prefix=$(npm config get prefix)" && echo "PATH=$PATH"
    - command -v postgres-ai && postgres-ai --help
    - command -v postgresai && postgresai --help
    - rm -f .pgwatch-config
    - node ./cli/dist/bin/postgres-ai.js add-key "test_key_1234567890"
    - node ./cli/dist/bin/postgres-ai.js show-key | grep -E "\*{2,}|[0-9]{4}$"
    - test -f ~/.config/postgresai/config.json
    - grep -q 'test_key' ~/.config/postgresai/config.json
    - node ./cli/dist/bin/postgres-ai.js remove-key
    - if grep -q 'apiKey' ~/.config/postgresai/config.json; then echo 'key not removed' && exit 1; fi
    - node ./cli/dist/bin/postgres-ai.js mon targets list | head -n 1 || true
    - node ./cli/dist/bin/postgres-ai.js mon targets add 'postgresql://user:pass@host:5432/db' ci-test || true
    - node ./cli/dist/bin/postgres-ai.js mon targets remove ci-test || true
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:node:tests:
  stage: test
  image: node:20-bullseye
  variables:
    GIT_STRATEGY: fetch
    NPM_CONFIG_AUDIT: "false"
    NPM_CONFIG_FUND: "false"
  before_script:
    - corepack enable || true
    - apt-get update
    - apt-get install -y --no-install-recommends postgresql postgresql-client && rm -rf /var/lib/apt/lists/*
    # initdb refuses to run as root; run CLI tests as an unprivileged user
    - useradd -m -s /bin/bash pgtest || true
    - chown -R pgtest:pgtest "$CI_PROJECT_DIR"
    - su - pgtest -c "cd \"$CI_PROJECT_DIR\" && node -v && npm -v && npm --prefix cli ci"
  script:
    - su - pgtest -c "cd \"$CI_PROJECT_DIR\" && npm --prefix cli test"
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:npm:publish:
  stage: publish
  image: node:20-bullseye
  variables:
    GIT_STRATEGY: fetch
    NPM_CONFIG_AUDIT: "false"
    NPM_CONFIG_FUND: "false"
  before_script:
    - corepack enable || true
    - node -v && npm -v
  script:
    - |
      set -euo pipefail
      : "${NPM_TOKEN:?NPM_TOKEN is required to publish}"

      # Supported tag formats (examples):
      # - v0.14.0-dev.1
      # - 0.14.0-dev.1
      # - 0.14-dev.1          (normalized to 0.14.0-dev.1)
      # - 0.14.0-rc.1
      # - v0.14.0            (stable, published to latest)
      RAW_TAG="${CI_COMMIT_TAG:-${CI_COMMIT_REF_NAME:-}}"
      if [ -z "$RAW_TAG" ]; then
        echo "CI_COMMIT_TAG is empty"
        exit 1
      fi

      TAG_VERSION="$RAW_TAG"
      TAG_VERSION="${TAG_VERSION#v}"

      # Normalize 0.14-dev.1 -> 0.14.0-dev.1 (also for beta/rc)
      if printf '%s' "$TAG_VERSION" | grep -Eq '^[0-9]+\.[0-9]+-(dev|beta|rc)\.[0-9]+$'; then
        TAG_VERSION="$(printf '%s' "$TAG_VERSION" | sed -E 's/^([0-9]+\.[0-9]+)-((dev|beta|rc)\.[0-9]+)$/\1.0-\2/')"
      fi

      DIST_TAG=""
      if printf '%s' "$TAG_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+-(dev|beta|rc)\.[0-9]+$'; then
        DIST_TAG="$(printf '%s' "$TAG_VERSION" | sed -E 's/^.*-(dev|beta|rc)\.[0-9]+$/\1/')"
      elif printf '%s' "$TAG_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
        DIST_TAG="latest"
      fi

      if [ "$DIST_TAG" != "dev" ] && [ "$DIST_TAG" != "beta" ] && [ "$DIST_TAG" != "rc" ] && [ "$DIST_TAG" != "latest" ]; then
        echo "Unsupported tag/version: $TAG_VERSION (expected X.Y.Z, X.Y.Z-dev.N, X.Y.Z-beta.N, or X.Y.Z-rc.N)"
        exit 1
      fi

      # Configure npm auth without committing credentials
      printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

      # Helper: check if package version exists on npm
      pkg_exists() {
        npm view "$1@$2" version >/dev/null 2>&1
      }

      # Helper: wait for package to be available on npm (max 60s)
      wait_for_pkg() {
        local pkg="$1" ver="$2" i=0
        while [ $i -lt 12 ]; do
          if pkg_exists "$pkg" "$ver"; then
            echo "✓ $pkg@$ver is available on npm"
            return 0
          fi
          echo "Waiting for $pkg@$ver to be available on npm..."
          sleep 5
          i=$((i + 1))
        done
        echo "✗ Timeout waiting for $pkg@$ver"
        return 1
      }

      echo "Publishing postgresai@${TAG_VERSION} to dist-tag ${DIST_TAG}"
      cd cli
      npm ci --no-audit --no-fund
      # Make the git tag the source of truth without committing version bumps.
      npm version --no-git-tag-version "$TAG_VERSION"
      npm run build
      if pkg_exists "postgresai" "$TAG_VERSION"; then
        echo "postgresai@${TAG_VERSION} already published, skipping"
      else
        npm publish --tag "$DIST_TAG" --access public
      fi

      # Wait for postgresai to be available before publishing wrapper
      wait_for_pkg "postgresai" "$TAG_VERSION"

      echo "Publishing pgai@${TAG_VERSION} (wrapper) to dist-tag ${DIST_TAG}"
      cd ../pgai
      # Update version + dependency so `npx pgai@<tag>` pulls the matching postgresai version.
      npm pkg set "dependencies.postgresai=$TAG_VERSION"
      npm version --no-git-tag-version "$TAG_VERSION"
      if pkg_exists "pgai" "$TAG_VERSION"; then
        echo "pgai@${TAG_VERSION} already published, skipping"
      else
        # No lockfile: use npm install here.
        npm install --no-audit --no-fund
        npm publish --tag "$DIST_TAG" --access public
      fi
  after_script:
    - rm -f ~/.npmrc
  rules:
    # prereleases (also allow patchless X.Y-dev.N, normalized in script)
    - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+(\.\d+)?-(dev|beta|rc)\.\d+$/'
    # stable releases
    - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+$/'
    # GitLab "Run pipeline" UI ("web" pipelines) often doesn't populate tag vars consistently.
    # Keep this job available manually so the pipeline is never empty; the script validates the ref name.
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual

cli:node:e2e:dind:
  stage: test
  image: node:20-alpine
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.43"
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
    - apk add --no-cache bash docker-cli docker-compose openssl postgresql-client
    - node -v && npm -v && docker version
    - npm --prefix cli install --no-audit --no-fund
  script:
    - ./tests/e2e.cli.sh
  after_script:
    - docker ps -a || true
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:node:full:dind:
  stage: test
  image: node:20-alpine
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.43"
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
    - apk add --no-cache bash git docker-cli docker-compose openssl postgresql-client
    - node -v && npm -v && docker version
    - npm --prefix cli install --no-audit --no-fund
  script:
    - echo "=== Testing quickstart (demo mode) ==="
    - node ./cli/dist/bin/postgres-ai.js mon quickstart --demo
    - sleep 10
    - node ./cli/dist/bin/postgres-ai.js mon status
    - echo ""
    - echo "=== Testing shell command ==="
    - echo "SELECT 1;" | node ./cli/dist/bin/postgres-ai.js mon shell target-db || true
    - echo ""
    - echo "=== Testing complete workflow ==="
    - node ./cli/dist/bin/postgres-ai.js mon targets add "postgresql://monitor:monitor_pass@target-db:5432/target_database" demo-test
    - node ./cli/dist/bin/postgres-ai.js mon targets list
    - node ./cli/dist/bin/postgres-ai.js mon targets test demo-test || true
    - node ./cli/dist/bin/postgres-ai.js mon health --wait 120
    - node ./cli/dist/bin/postgres-ai.js mon show-grafana-credentials
    - echo ""
    - echo "=== Cleanup ==="
    - node ./cli/dist/bin/postgres-ai.js mon stop
    - node ./cli/dist/bin/postgres-ai.js mon clean || true
  after_script:
    - docker ps -a || true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH =~ /^feature\//'
  allow_failure: false

cli:node:integration:
  stage: test
  image: node:20-alpine
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
    - node -v && npm -v
    - npm --prefix cli install --no-audit --no-fund
  script:
    - |
      set -euo pipefail
      : "${PGAI_API_KEY:?PGAI_API_KEY is required for integration tests}"
      BASE_URL="${PGAI_BASE_URL:-https://v2.postgres.ai/api/general/}"
      echo "Using BASE_URL=$BASE_URL"
      # Placeholder: run CLI help until API-backed commands are implemented
      node ./cli/dist/bin/postgres-ai.js --help
  rules:
    - if: '$PGAI_API_KEY'


