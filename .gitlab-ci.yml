include:
  - local: 'components/index_pilot/.gitlab-ci.yml'

stages:
  - test
  - publish

reporter:tests:
  stage: test
  image: python:3.11-bullseye
  variables:
    GIT_STRATEGY: fetch
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    PIP_NO_CACHE_DIR: "1"
  before_script:
    - python --version
    - pip install --upgrade pip
    - apt-get update
    - apt-get install -y --no-install-recommends postgresql postgresql-client && rm -rf /var/lib/apt/lists/*
    - pip install -r reporter/requirements-dev.txt
  script:
    - chown -R postgres:postgres "$CI_PROJECT_DIR"
    - su - postgres -c "cd \"$CI_PROJECT_DIR\" && python -m pytest --run-integration tests/reporter"
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:smoke:test:
  stage: test
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - apk add --no-cache bash curl git docker-cli docker-compose
  script:
    - bash -n ./postgres_ai
    - |
      set -euo pipefail
      out=$(./postgres_ai help | tr -d "\r")
      echo "$out" | grep -q "Postgres AI CLI"
      echo "$out" | grep -q "COMMANDS:"
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:e2e:dind:
  stage: test
  image: alpine:3.20
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.43"
    GIT_STRATEGY: fetch
  before_script:
    - apk add --no-cache bash curl git coreutils docker-cli docker-compose openssl
    - docker version
  script:
    - set -euo pipefail
    - bash -n ./postgres_ai
    - ./postgres_ai check || true
    - ./postgres_ai quickstart --demo -y
    - timeout 60 ./postgres_ai status
    - timeout 10 ./postgres_ai logs grafana || true
    - ./postgres_ai config
    - ./postgres_ai update-config
    - ./postgres_ai list-instances || true
    - ./postgres_ai add-key "test_key_123"
    - ./postgres_ai show-key
    - ./postgres_ai remove-key
    - ./postgres_ai generate-grafana-password || true
    - ./postgres_ai show-grafana-credentials || true
    - ./postgres_ai add-instance "postgresql://postgres:postgres@target-db:5432/target_database" "ci-demo"
    - ./postgres_ai test-instance "ci-demo" || true
    - printf "y\n" | ./postgres_ai reset sink-postgres
    - ./postgres_ai restart
    - ./postgres_ai stop
    - ./postgres_ai start
    - printf "y\n" | ./postgres_ai reset
    - ./postgres_ai clean
  after_script:
    - docker ps -a || true
    - docker system prune -af || true
  rules:
    - if: '$CI_COMMIT_BRANCH'
cli:node:smoke:
  stage: test
  image: node:20-alpine
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
  script:
    - node -v && npm -v
    - npm --prefix cli install --no-audit --no-fund
    - node ./cli/dist/bin/postgres-ai.js --help
    - node ./cli/dist/bin/postgres-ai.js mon status --help
    - node ./cli/dist/bin/postgres-ai.js mon targets list --help
    - npm install -g ./cli
    - echo "prefix=$(npm config get prefix)" && echo "PATH=$PATH"
    - command -v postgres-ai && postgres-ai --help
    - command -v postgresai && postgresai --help
    - rm -f .pgwatch-config
    - node ./cli/dist/bin/postgres-ai.js add-key "test_key_1234567890"
    - node ./cli/dist/bin/postgres-ai.js show-key | grep -E "\*{2,}|[0-9]{4}$"
    - test -f ~/.config/postgresai/config.json
    - grep -q 'test_key' ~/.config/postgresai/config.json
    - node ./cli/dist/bin/postgres-ai.js remove-key
    - if grep -q 'apiKey' ~/.config/postgresai/config.json; then echo 'key not removed' && exit 1; fi
    - node ./cli/dist/bin/postgres-ai.js mon targets list | head -n 1 || true
    - node ./cli/dist/bin/postgres-ai.js mon targets add 'postgresql://user:pass@host:5432/db' ci-test || true
    - node ./cli/dist/bin/postgres-ai.js mon targets remove ci-test || true
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:node:tests:
  stage: test
  image: node:20-bullseye
  variables:
    GIT_STRATEGY: fetch
    NPM_CONFIG_AUDIT: "false"
    NPM_CONFIG_FUND: "false"
  before_script:
    - corepack enable || true
    - apt-get update
    - apt-get install -y --no-install-recommends postgresql postgresql-client && rm -rf /var/lib/apt/lists/*
    # initdb refuses to run as root; run CLI tests as an unprivileged user
    - useradd -m -s /bin/bash pgtest || true
    - chown -R pgtest:pgtest "$CI_PROJECT_DIR"
    - su - pgtest -c "cd \"$CI_PROJECT_DIR\" && node -v && npm -v && npm --prefix cli ci"
  script:
    - su - pgtest -c "cd \"$CI_PROJECT_DIR\" && npm --prefix cli test"
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:npm:publish:
  stage: publish
  image: node:20-bullseye
  variables:
    GIT_STRATEGY: fetch
    NPM_CONFIG_AUDIT: "false"
    NPM_CONFIG_FUND: "false"
  before_script:
    - corepack enable || true
    - node -v && npm -v
  script:
    - |
      set -euo pipefail
      : "${NPM_TOKEN:?NPM_TOKEN is required to publish}"

      RAW_TAG="${CI_COMMIT_TAG:-}"
      if [ -z "$RAW_TAG" ]; then
        echo "CI_COMMIT_TAG is empty"
        exit 1
      fi

      # npm requires SemVer. We accept an optional leading 'v' in git tags for npm publishing,
      # but the raw git tag is still treated as the canonical version string elsewhere (e.g. in container /VERSION).
      TAG_VERSION="$RAW_TAG"
      NPM_VERSION="${RAW_TAG#v}"
      if ! printf '%s' "$NPM_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+([\-+][0-9A-Za-z.-]+)?$'; then
        echo "Invalid npm version derived from git tag: RAW_TAG='$RAW_TAG' -> NPM_VERSION='$NPM_VERSION' (must be SemVer)"
        exit 1
      fi

      DIST_TAG=""
      if printf '%s' "$NPM_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+-(dev|beta|rc)\.[0-9]+$'; then
        DIST_TAG="$(printf '%s' "$NPM_VERSION" | sed -E 's/^.*-(dev|beta|rc)\.[0-9]+$/\1/')"
      elif printf '%s' "$NPM_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
        DIST_TAG="latest"
      fi

      if [ "$DIST_TAG" != "dev" ] && [ "$DIST_TAG" != "beta" ] && [ "$DIST_TAG" != "rc" ] && [ "$DIST_TAG" != "latest" ]; then
        echo "Unsupported version: $NPM_VERSION (expected X.Y.Z, X.Y.Z-dev.N, X.Y.Z-beta.N, or X.Y.Z-rc.N)"
        exit 1
      fi

      # Configure npm auth without committing credentials
      printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

      echo "Publishing postgresai@${NPM_VERSION} to dist-tag ${DIST_TAG}"
      cd cli
      npm ci --no-audit --no-fund
      # Make the git tag the source of truth without committing version bumps.
      npm version --no-git-tag-version "$NPM_VERSION"
      npm run build
      npm publish --dry-run --tag "$DIST_TAG" --access public
      npm publish --tag "$DIST_TAG" --access public

      # Wait until the registry sees the new postgresai version. This prevents the pgai step from
      # failing due to eventual consistency when verifying/pinning dependencies.
      for i in $(seq 1 30); do
        if npm view "postgresai@${NPM_VERSION}" version >/dev/null 2>&1; then
          break
        fi
        echo "Waiting for npm to recognize postgresai@${NPM_VERSION} (attempt $i/30)..."
        sleep 2
      done
      npm view "postgresai@${NPM_VERSION}" version >/dev/null

      echo "Publishing pgai@${NPM_VERSION} (wrapper) to dist-tag ${DIST_TAG}"
      cd ../pgai
      # Update version + dependency so `npx pgai@<tag>` pulls the matching postgresai version.
      npm pkg set "dependencies.postgresai=$NPM_VERSION"
      npm version --no-git-tag-version "$NPM_VERSION"
      npm publish --dry-run --tag "$DIST_TAG" --access public
      npm publish --tag "$DIST_TAG" --access public

      # Verify both packages are visible as published versions.
      npm view "postgresai@${NPM_VERSION}" version >/dev/null
      npm view "pgai@${NPM_VERSION}" version >/dev/null
  after_script:
    - rm -f ~/.npmrc
  rules:
    - if: '$CI_COMMIT_TAG'

.docker-publish-base: &docker-publish-base
  stage: publish
  image: docker:27.3
  services:
    - name: docker:27.3-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.45"
    GIT_STRATEGY: fetch

.docker-build-script: &docker-build-script |
  echo "Logging into container registry..."
  echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY" -u "$REGISTRY_USER" --password-stdin

  echo "Enabling binfmt (QEMU) for multi-arch builds..."
  docker run --privileged --rm tonistiigi/binfmt --install all

  echo "Creating/using buildx builder..."
  docker buildx create --name postgres-ai-builder --use 2>/dev/null || docker buildx use postgres-ai-builder
  docker buildx inspect --bootstrap

  echo "Building and pushing images: $VERSION"
  echo "  Platforms: $PLATFORMS"
  echo "  BUILD_TS: $BUILD_TS"
  if [ "${PUBLISH_LATEST:-false}" = "true" ]; then
    echo "  Also tagging as: latest"
  fi

  docker buildx build \
    --platform "$PLATFORMS" \
    --build-arg "VERSION=$VERSION" \
    --build-arg "BUILD_TS=$BUILD_TS" \
    -f reporter/Dockerfile \
    -t "postgresai/reporter:$VERSION" \
    ${PUBLISH_LATEST:+-t "postgresai/reporter:latest"} \
    --push \
    reporter

  docker buildx build \
    --platform "$PLATFORMS" \
    --build-arg "VERSION=$VERSION" \
    --build-arg "BUILD_TS=$BUILD_TS" \
    -f monitoring_flask_backend/Dockerfile \
    -t "postgresai/monitoring_flask_backend:$VERSION" \
    ${PUBLISH_LATEST:+-t "postgresai/monitoring_flask_backend:latest"} \
    --push \
    monitoring_flask_backend

  echo ""
  echo "Published images:"
  echo "  postgresai/reporter:$VERSION"
  echo "  postgresai/monitoring_flask_backend:$VERSION"
  if [ "${PUBLISH_LATEST:-false}" = "true" ]; then
    echo "  postgresai/reporter:latest"
    echo "  postgresai/monitoring_flask_backend:latest"
  fi

docker:publish:images:
  <<: *docker-publish-base
  script:
    - |
      set -euo pipefail
      REGISTRY="${DH_CI_REGISTRY:-${DOCKERHUB_REGISTRY:-docker.io}}"
      REGISTRY_USER="${DH_CI_REGISTRY_USER:-${DOCKERHUB_USERNAME:-}}"
      REGISTRY_PASSWORD="${DH_CI_REGISTRY_PASSWORD:-${DOCKERHUB_TOKEN:-}}"
      : "${REGISTRY_USER:?DH_CI_REGISTRY_USER (or DOCKERHUB_USERNAME) is required}"
      : "${REGISTRY_PASSWORD:?DH_CI_REGISTRY_PASSWORD (or DOCKERHUB_TOKEN) is required}"

      RAW_TAG="${CI_COMMIT_TAG:-}"
      if [ -z "$RAW_TAG" ]; then
        echo "CI_COMMIT_TAG is empty"
        exit 1
      fi

      if ! printf '%s' "$RAW_TAG" | grep -Eq '^[A-Za-z0-9][A-Za-z0-9_.-]{0,127}$'; then
        echo "Invalid Docker tag: '$RAW_TAG' (must match ^[A-Za-z0-9][A-Za-z0-9_.-]{0,127}$)"
        exit 1
      fi

      # Only stable SemVer tags update :latest (e.g. 0.14.0 or v0.14.0)
      if printf '%s' "$RAW_TAG" | grep -Eq '^v?[0-9]+\.[0-9]+\.[0-9]+$'; then
        PUBLISH_LATEST=true
      else
        PUBLISH_LATEST=false
      fi

      VERSION="$RAW_TAG"
      BUILD_TS="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      PLATFORMS="${PLATFORMS:-linux/amd64,linux/arm64}"
    - *docker-build-script
  rules:
    - if: '$CI_COMMIT_TAG'

docker:publish:dev:
  <<: *docker-publish-base
  script:
    - |
      set -euo pipefail
      REGISTRY="${DH_CI_REGISTRY:-${DOCKERHUB_REGISTRY:-docker.io}}"
      REGISTRY_USER="${DH_CI_REGISTRY_USER:-${DOCKERHUB_USERNAME:-}}"
      REGISTRY_PASSWORD="${DH_CI_REGISTRY_PASSWORD:-${DOCKERHUB_TOKEN:-}}"
      : "${REGISTRY_USER:?DH_CI_REGISTRY_USER (or DOCKERHUB_USERNAME) is required}"
      : "${REGISTRY_PASSWORD:?DH_CI_REGISTRY_PASSWORD (or DOCKERHUB_TOKEN) is required}"

      SHORT_SHA="$(echo "$CI_COMMIT_SHA" | cut -c1-8)"
      VERSION="dev-${SHORT_SHA}"
      BUILD_TS="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      PLATFORMS="${PLATFORMS:-linux/amd64}"

      echo "Branch: $CI_COMMIT_REF_NAME"
      echo "Commit: $CI_COMMIT_SHA"
      echo "Version: $VERSION"
    - *docker-build-script
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual

release:verify:
  stage: publish
  image: docker:27.3
  services:
    - name: docker:27.3-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.45"
    GIT_STRATEGY: fetch
  needs:
    - job: cli:npm:publish
      optional: true
    - job: docker:publish:images
      optional: true
  script:
    - apk add --no-cache nodejs npm bash coreutils grep
    - |
      set -euo pipefail

      RAW_TAG="${CI_COMMIT_TAG:-}"
      if [ -z "$RAW_TAG" ]; then
        echo "CI_COMMIT_TAG is empty"
        exit 1
      fi

      # Enforce your policy: use git tag as version, and fail if incompatible.
      NPM_VERSION="${RAW_TAG#v}"
      if ! printf '%s' "$NPM_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+([\-+][0-9A-Za-z.-]+)?$'; then
        echo "Invalid npm version derived from git tag: RAW_TAG='$RAW_TAG' -> NPM_VERSION='$NPM_VERSION' (must be SemVer)"
        exit 1
      fi
      if ! printf '%s' "$RAW_TAG" | grep -Eq '^[A-Za-z0-9][A-Za-z0-9_.-]{0,127}$'; then
        echo "Invalid Docker tag: '$RAW_TAG' (must match ^[A-Za-z0-9][A-Za-z0-9_.-]{0,127}$)"
        exit 1
      fi

      echo "Verifying npm package availability..."
      npm view "postgresai@${NPM_VERSION}" version
      npm view "pgai@${NPM_VERSION}" version

      echo "Verifying Docker images availability and metadata..."
      REGISTRY="${DH_CI_REGISTRY:-${DOCKERHUB_REGISTRY:-docker.io}}"
      REGISTRY_USER="${DH_CI_REGISTRY_USER:-${DOCKERHUB_USERNAME:-}}"
      REGISTRY_PASSWORD="${DH_CI_REGISTRY_PASSWORD:-${DOCKERHUB_TOKEN:-}}"
      : "${REGISTRY_USER:?DH_CI_REGISTRY_USER (or DOCKERHUB_USERNAME) is required}"
      : "${REGISTRY_PASSWORD:?DH_CI_REGISTRY_PASSWORD (or DOCKERHUB_TOKEN) is required}"
      echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY" -u "$REGISTRY_USER" --password-stdin

      docker pull "postgresai/reporter:${RAW_TAG}"
      docker pull "postgresai/monitoring_flask_backend:${RAW_TAG}"

      # Confirm multi-arch manifests include both amd64 and arm64.
      docker buildx imagetools inspect "postgresai/reporter:${RAW_TAG}" | grep -q "linux/amd64"
      docker buildx imagetools inspect "postgresai/reporter:${RAW_TAG}" | grep -q "linux/arm64"
      docker buildx imagetools inspect "postgresai/monitoring_flask_backend:${RAW_TAG}" | grep -q "linux/amd64"
      docker buildx imagetools inspect "postgresai/monitoring_flask_backend:${RAW_TAG}" | grep -q "linux/arm64"

      # Validate embedded files for this runner's arch.
      test "$(docker run --rm "postgresai/reporter:${RAW_TAG}" cat /VERSION)" = "$RAW_TAG"
      test "$(docker run --rm "postgresai/monitoring_flask_backend:${RAW_TAG}" cat /VERSION)" = "$RAW_TAG"
      docker run --rm "postgresai/reporter:${RAW_TAG}" cat /BUILD_TS | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} UTC$'
      docker run --rm "postgresai/monitoring_flask_backend:${RAW_TAG}" cat /BUILD_TS | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} UTC$'
  rules:
    - if: '$CI_COMMIT_TAG'

cli:node:e2e:dind:
  stage: test
  image: node:20-alpine
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.43"
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
    - apk add --no-cache bash docker-cli docker-compose openssl postgresql-client
    - node -v && npm -v && docker version
    - npm --prefix cli install --no-audit --no-fund
  script:
    - ./tests/e2e.cli.sh
  after_script:
    - docker ps -a || true
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:node:full:dind:
  stage: test
  image: node:20-alpine
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_API_VERSION: "1.43"
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
    - apk add --no-cache bash git docker-cli docker-compose openssl postgresql-client
    - node -v && npm -v && docker version
    - npm --prefix cli install --no-audit --no-fund
  script:
    - echo "=== Testing quickstart (demo mode) ==="
    - node ./cli/dist/bin/postgres-ai.js mon quickstart --demo
    - sleep 10
    - node ./cli/dist/bin/postgres-ai.js mon status
    - echo ""
    - echo "=== Testing shell command ==="
    - echo "SELECT 1;" | node ./cli/dist/bin/postgres-ai.js mon shell target-db || true
    - echo ""
    - echo "=== Testing complete workflow ==="
    - node ./cli/dist/bin/postgres-ai.js mon targets add "postgresql://monitor:monitor_pass@target-db:5432/target_database" demo-test
    - node ./cli/dist/bin/postgres-ai.js mon targets list
    - node ./cli/dist/bin/postgres-ai.js mon targets test demo-test || true
    - node ./cli/dist/bin/postgres-ai.js mon health --wait 120
    - node ./cli/dist/bin/postgres-ai.js mon show-grafana-credentials
    - echo ""
    - echo "=== Cleanup ==="
    - node ./cli/dist/bin/postgres-ai.js mon stop
    - node ./cli/dist/bin/postgres-ai.js mon clean || true
  after_script:
    - docker ps -a || true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH =~ /^feature\//'
  allow_failure: false

cli:node:integration:
  stage: test
  image: node:20-alpine
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
    - node -v && npm -v
    - npm --prefix cli install --no-audit --no-fund
  script:
    - |
      set -euo pipefail
      : "${PGAI_API_KEY:?PGAI_API_KEY is required for integration tests}"
      BASE_URL="${PGAI_BASE_URL:-https://v2.postgres.ai/api/general/}"
      echo "Using BASE_URL=$BASE_URL"
      # Placeholder: run CLI help until API-backed commands are implemented
      node ./cli/dist/bin/postgres-ai.js --help
  rules:
    - if: '$PGAI_API_KEY'


