stages:
  - test

cli:smoke:test:
  stage: test
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - apk add --no-cache bash curl git docker-cli docker-compose
  script:
    - bash -n ./postgres_ai
    - |
      set -euo pipefail
      out=$(./postgres_ai help | tr -d "\r")
      echo "$out" | grep -q "Postgres AI CLI"
      echo "$out" | grep -q "COMMANDS:"
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:node:smoke:
  stage: test
  image: node:20-alpine
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
  script:
    - node -v && npm -v
    - npm --prefix cli install --no-audit --no-fund
    - node ./cli/bin/postgres-ai.js --help
    - node ./cli/bin/postgres-ai.js status --help
    - node ./cli/bin/postgres-ai.js list-instances --help
  rules:
    - if: '$CI_COMMIT_BRANCH'

cli:node:integration:
  stage: test
  image: node:20-alpine
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - corepack enable || true
    - node -v && npm -v
    - npm --prefix cli install --no-audit --no-fund
  script:
    - |
      set -euo pipefail
      : "${PGAIS_API_KEY:?PGAIS_API_KEY is required for integration tests}"
      BASE_URL="${PGAIS_BASE_URL:-https://v2.postgres.ai/api/general/}"
      echo "Using BASE_URL=$BASE_URL"
      # Placeholder: run CLI help until API-backed commands are implemented
      node ./cli/bin/postgres-ai.js --help
  rules:
    - if: '$PGAIS_API_KEY'


