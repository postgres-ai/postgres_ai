# GitLab CI/CD configuration for pg_index_pilot component
# Alpha for 0.14 - tests are allow_failure until stable

variables:
  POSTGRES_DB: test_index_pilot
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST: postgres
  POSTGRES_HOST_AUTH_METHOD: trust
  POSTGRES_INITDB_ARGS: "--auth-host=md5 --auth-local=trust"

index_pilot:shell:lint:
  stage: test
  image: alpine:latest
  allow_failure: true  # Alpha for 0.14
  script:
    - apk add --no-cache shellcheck shfmt
    - cd $CI_PROJECT_DIR/components/index_pilot
    - |
      FILES="$(find . -type f -name '*.sh' | tr '\n' ' ')"
      if [ -z "$FILES" ]; then
        echo "No shell files found"
        exit 0
      fi
      echo "Running shfmt check..."
      shfmt -i 2 -ci -bn -sr -d $FILES
      echo "Running shellcheck..."
      shellcheck -x $FILES
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - components/index_pilot/**/*

# Test against multiple PostgreSQL versions
.index_pilot_test_template: &index_pilot_test_definition
  stage: test
  image: postgres:alpine
  allow_failure: true  # Alpha for 0.14
  script:
    - apk add --no-cache bash
    - |
      echo "Waiting for PostgreSQL to be ready..."
      WAIT_TIME=0
      until PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U postgres -c "SELECT 1" > /dev/null 2>&1 || [ $WAIT_TIME -eq 30 ]; do
        sleep 2
        WAIT_TIME=$((WAIT_TIME + 2))
      done
      if [ $WAIT_TIME -eq 30 ]; then
        echo "ERROR: Database failed to start within 30 seconds"
        exit 1
      fi
    - |
      echo "PostgreSQL version:"
      PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U postgres -c "SELECT version();"
    - |
      echo "Running test suite..."
      cd $CI_PROJECT_DIR/components/index_pilot
      chmod +x test/run_tests.sh
      ./test/run_tests.sh -h postgres -u postgres -w "$POSTGRES_PASSWORD" -d test_index_pilot
  artifacts:
    reports:
      junit: components/index_pilot/test/test-results.xml
    when: always
    paths:
      - components/index_pilot/test/test-results.xml
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - components/index_pilot/**/*

index_pilot:test:pg16:
  <<: *index_pilot_test_definition
  services:
    - name: postgres:16-alpine
      alias: postgres

index_pilot:test:pg17:
  <<: *index_pilot_test_definition
  services:
    - name: postgres:17-alpine
      alias: postgres

.index_pilot_install_sh_template: &index_pilot_install_sh_template
  stage: test
  allow_failure: true  # Alpha for 0.14
  variables:
    CONTROL_DB: index_pilot_control_ci
    TARGET_DB: postgres
    PGPASSWORD: postgres
  before_script:
    - apk add --no-cache bash coreutils postgresql-client
    - |
      echo "Waiting for PostgreSQL to be ready..."
      for i in $(seq 1 30); do
        if pg_isready -h postgres -p 5432 -U postgres >/dev/null 2>&1; then
          echo "Database ready after $((i*2)) seconds"; break
        fi
        sleep 2
        if [ "$i" -eq 30 ]; then echo "ERROR: DB not ready"; exit 1; fi
      done
    - |
      POSTGRES_IP=$(psql -h postgres -U postgres -d postgres -tAc "select host(inet_server_addr())")
      echo "POSTGRES_IP=$POSTGRES_IP"
      if [ -z "$POSTGRES_IP" ]; then echo "ERROR: cannot determine Postgres IP"; exit 1; fi
    - cd $CI_PROJECT_DIR/components/index_pilot
    - chmod +x ./index_pilot.sh
  script:
    - cd $CI_PROJECT_DIR/components/index_pilot
    - |
      POSTGRES_IP=$(psql -h postgres -U postgres -d postgres -tAc "select host(inet_server_addr())")
      ./index_pilot.sh install-control \
        -H "$POSTGRES_IP" -P 5432 -U postgres -W "$PGPASSWORD" -C "$CONTROL_DB"
    - |
      ./index_pilot.sh register-target \
        -H postgres -P 5432 -U postgres -W "$PGPASSWORD" -C "$CONTROL_DB" \
        -T "$TARGET_DB" --server-name "target_${TARGET_DB}" --fdw-host localhost --force
    - |
      ./index_pilot.sh verify -H postgres -P 5432 -U postgres -W "$PGPASSWORD" -C "$CONTROL_DB" | tee /tmp/verify.txt
    - grep -q "registered targets|t|postgres" /tmp/verify.txt
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - components/index_pilot/**/*

index_pilot:install_sh:pg16:
  <<: *index_pilot_install_sh_template
  image: postgres:16-alpine
  services:
    - name: postgres:16-alpine
      alias: postgres

index_pilot:install_sh:pg17:
  <<: *index_pilot_install_sh_template
  image: postgres:17-alpine
  services:
    - name: postgres:17-alpine
      alias: postgres

# Test on managed service simulation (non-superuser)
index_pilot:test:nonsuperuser:
  stage: test
  image: postgres:16-alpine
  allow_failure: true  # Alpha for 0.14
  services:
    - name: postgres:16-alpine
      alias: postgres
  before_script:
    - apk add --no-cache bash
    - |
      WAIT_TIME=0
      until PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U postgres -c "SELECT 1" > /dev/null 2>&1 || [ $WAIT_TIME -eq 30 ]; do
        sleep 2
        WAIT_TIME=$((WAIT_TIME + 2))
      done
  script:
    - |
      PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U postgres << EOF
      CREATE DATABASE test_index_pilot;
      CREATE USER index_pilot WITH PASSWORD 'testpass';
      GRANT CONNECT, CREATE ON DATABASE test_index_pilot TO index_pilot;
      \c test_index_pilot
      CREATE EXTENSION dblink;
      CREATE EXTENSION postgres_fdw;
      GRANT USAGE ON FOREIGN DATA WRAPPER postgres_fdw TO index_pilot;
      EOF
    - |
      PGPASSWORD=testpass psql -h postgres -U index_pilot -d test_index_pilot -f $CI_PROJECT_DIR/components/index_pilot/index_pilot_tables.sql
      PGPASSWORD=testpass psql -h postgres -U index_pilot -d test_index_pilot -f $CI_PROJECT_DIR/components/index_pilot/index_pilot_functions.sql
      PGPASSWORD=testpass psql -h postgres -U index_pilot -d test_index_pilot -f $CI_PROJECT_DIR/components/index_pilot/index_pilot_fdw.sql
    - |
      POSTGRES_IP=$(PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U postgres -d test_index_pilot -tAc "SELECT host(inet_server_addr())" || echo "postgres")
      PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U postgres -d test_index_pilot << EOF
      SELECT index_pilot.setup_fdw_self_connection('$POSTGRES_IP', 5432, 'test_index_pilot');
      SELECT index_pilot.setup_user_mapping('postgres', '$POSTGRES_PASSWORD');
      SELECT index_pilot.setup_user_mapping('index_pilot', 'testpass');
      EOF
    - |
      cd $CI_PROJECT_DIR/components/index_pilot
      chmod +x test/run_tests.sh
      SKIP_INSTALL=true ./test/run_tests.sh -h postgres -u index_pilot -w testpass -d test_index_pilot
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - components/index_pilot/**/*

# SQL security checks
index_pilot:sql-security:
  stage: test
  image: alpine:latest
  allow_failure: true  # Alpha for 0.14
  script:
    - apk add --no-cache grep
    - cd $CI_PROJECT_DIR/components/index_pilot
    - |
      echo "Checking for SQL injection vulnerabilities..."
      if grep -E "EXECUTE[[:space:]]+[^;]*\|\|[[:space:]]*[^';]*\|\|" *.sql | grep -v "format\|quote_ident\|quote_literal" 2>/dev/null; then
        echo "ERROR: Potential SQL injection"
        exit 1
      fi
    - |
      echo "Checking for hardcoded passwords..."
      if grep -E "(PASSWORD|IDENTIFIED BY)[[:space:]]*[=:][[:space:]]*'[^']+'" *.sql | grep -v "your_secure_password\|your_password\|changeme\|testpass" 2>/dev/null; then
        echo "ERROR: Hardcoded password found"
        exit 1
      fi
    - echo "âœ… SQL security checks passed"
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - components/index_pilot/**/*

# E2E bloat reduction test
index_pilot:e2e:bloat-reduction:
  stage: test
  image: postgres:17-alpine
  allow_failure: true  # Alpha for 0.14
  services:
    - name: postgres:17-alpine
      alias: postgres
  before_script:
    - apk add --no-cache bash coreutils
    - cd $CI_PROJECT_DIR/components/index_pilot
    - chmod +x ci/e2e_bloat_reduction.sh
  script:
    - cd $CI_PROJECT_DIR/components/index_pilot
    - ./ci/e2e_bloat_reduction.sh
  timeout: 1h
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - components/index_pilot/**/*

