services:
  # Example local-dev override file.
  #
  # Usage:
  #   cp docker-compose.override.example.yml docker-compose.override.yml
  #
  # Docker Compose automatically loads docker-compose.override.yml (no -f needed).

  # Use local repo configs instead of the published postgres-ai-configs image.
  # This copies files from ./config into the shared volume (postgres_ai_configs).
  #
  # IMPORTANT: this copy is careful to NOT delete generated files (like sources.yml).
  config-init:
    image: alpine:3.22.0
    container_name: postgres-ai-config-init
    volumes:
      - postgres_ai_configs:/target
      - ./config:/src:ro
    environment:
      - TARGET_DIR=/target
    command:
      [
        "sh",
        "-lc",
        "set -eu; \
         mkdir -p /target/grafana /target/pgwatch /target/pgwatch-prometheus /target/prometheus /target/sink-postgres /target/target-db /target/scripts; \
         cp -a /src/grafana/. /target/grafana/; \
         cp -a /src/prometheus/. /target/prometheus/; \
         cp -a /src/sink-postgres/. /target/sink-postgres/; \
         cp -a /src/target-db/. /target/target-db/; \
         cp -a /src/scripts/. /target/scripts/; \
         cp -f /src/pgwatch-postgres/metrics.yml /target/pgwatch/metrics.yml; \
         cp -f /src/pgwatch-prometheus/metrics.yml /target/pgwatch-prometheus/metrics.yml; \
         echo \"config-init (local): copied ./config -> postgres_ai_configs volume\""
      ]

  # Local dev override for the metrics server:
  # - bind-mount local code for instant iteration
  # - expose HTTP port to host
  metrics-server:
    ports:
      # HTTP
      - "127.0.0.1:55000:8000"
    volumes:
      - ./cli/lib:/app/lib
    environment:
      - PROMETHEUS_URL=http://sink-prometheus:9090
      - PORT=8000

  # Alternate mode: run/debug the reporter inside Docker.
  #
  # NOTE: The primary dev workflow is running reports on the host via:
  #   cd cli && bun run lib/reporter.ts --prometheus-url http://localhost:59090
  #
  # The host-run workflow is faster and easier to debug, and is enabled by:
  # - exposing sink-postgres on 127.0.0.1:55433 (see below)
  # - exposing VictoriaMetrics on http://127.0.0.1:59090 (from docker-compose.yml)
  #
  # If you specifically want the *container-based* reporter to use your local code, uncomment:
  #
  # postgres-reports:
  #   volumes:
  #     - ./cli/lib:/app/lib
  #   environment:
  #     - PROMETHEUS_URL=http://sink-prometheus:9090
  #     - REPORTER_INITIAL_DELAY_SECONDS=0

  # Expose sink-postgres to the host so you can run/debug reporter locally.
  # Bound to localhost only (safe for local dev).
  sink-postgres:
    ports:
      - "127.0.0.1:55433:5432"

  # Optional: expose demo DB too (only useful if you run `target-db`)
  # target-db:
  #   ports:
  #     - "127.0.0.1:55432:5432"


