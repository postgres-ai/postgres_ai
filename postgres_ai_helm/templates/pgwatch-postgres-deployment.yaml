{{- if .Values.pgwatchPostgres.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "postgres-ai-monitoring.fullname" . }}-pgwatch-postgres
  namespace: {{ include "postgres-ai-monitoring.namespace" . }}
  labels:
    {{- include "postgres-ai-monitoring.labels" . | nindent 4 }}
    app.kubernetes.io/component: pgwatch-postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "postgres-ai-monitoring.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: pgwatch-postgres
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/pgwatch-config.yaml") . | sha256sum }}
      labels:
        {{- include "postgres-ai-monitoring.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: pgwatch-postgres
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: wait-for-sink
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z {{ include "postgres-ai-monitoring.fullname" . }}-sink-postgres 5432; do echo waiting for postgres; sleep 2; done']
        - name: inject-passwords
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              set -eu
              # Copy sources file from configmap
              cp /config/sources-postgres.yml /output/sources-postgres.yml
              {{- range $db := .Values.monitoredDatabases }}
              {{- if not $db.connStr }}
              # Replace password placeholder for {{ $db.name }}
              if [ -n "${DB_PASSWORD_{{ $db.passwordSecretKey | upper | replace "-" "_" }}:-}" ]; then
                sed -i "s|PASSWORD_PLACEHOLDER_{{ $db.passwordSecretKey }}|${DB_PASSWORD_{{ $db.passwordSecretKey | upper | replace "-" "_" }}}|g" /output/sources-postgres.yml
              fi
              {{- end }}
              {{- end }}
          volumeMounts:
            - name: config-template
              mountPath: /config
            - name: sources-config
              mountPath: /output
          env:
            {{- range $db := .Values.monitoredDatabases }}
            {{- if not $db.connStr }}
            - name: DB_PASSWORD_{{ $db.passwordSecretKey | upper | replace "-" "_" }}
              valueFrom:
                secretKeyRef:
                  name: {{ include "postgres-ai-monitoring.secretName" $ }}
                  key: db-password-{{ $db.passwordSecretKey }}
            {{- end }}
            {{- end }}
      containers:
        - name: pgwatch
          image: {{ .Values.pgwatchPostgres.image }}
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              exec /pgwatch/pgwatch \
                --sources=/etc/pgwatch/sources.yml \
                --metrics=/etc/pgwatch/metrics.yml \
                --sink=postgresql://{{ .Values.sinkPostgres.user }}:${POSTGRES_PASSWORD}@{{ include "postgres-ai-monitoring.fullname" . }}-sink-postgres:5432/{{ .Values.sinkPostgres.database }}?sslmode=disable \
                --web-addr=:8080 \
                --log-level={{ .Values.pgwatchPostgres.logLevel | default "error" }}
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "postgres-ai-monitoring.secretName" . }}
                  key: postgres-password
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: sources-config
              mountPath: /etc/pgwatch/sources.yml
              subPath: sources-postgres.yml
            - name: metrics-config
              mountPath: /etc/pgwatch/metrics.yml
              subPath: metrics-postgres.yml
          {{- with .Values.pgwatchPostgres.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      volumes:
        - name: config-template
          configMap:
            name: {{ include "postgres-ai-monitoring.fullname" . }}-pgwatch-config
        - name: sources-config
          emptyDir: {}
        - name: metrics-config
          configMap:
            name: {{ include "postgres-ai-monitoring.fullname" . }}-pgwatch-config
{{- end }}


