{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "D004 report schema",
  "type": "object",
  "additionalProperties": false,
  "required": ["checkId", "checkTitle", "timestamptz", "nodes", "results"],
  "properties": {
    "version": { "type": ["string", "null"] },
    "build_ts": { "type": ["string", "null"] },
    "checkId": { "const": "D004" },
    "checkTitle": { "const": "pg_stat_statements and pg_stat_kcache settings" },
    "timestamptz": { "type": "string" },
    "nodes": { "$ref": "#/$defs/nodes" },
    "results": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": { "$ref": "#/$defs/nodeResult" }
    }
  },
  "$defs": {
    "nodes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["primary", "standbys"],
      "properties": {
        "primary": { "type": "string" },
        "standbys": { "type": "array", "items": { "type": "string" } }
      }
    },
    "postgresVersion": {
      "type": "object",
      "additionalProperties": false,
      "required": ["version", "server_version_num", "server_major_ver", "server_minor_ver"],
      "properties": {
        "version": { "type": "string" },
        "server_version_num": { "type": "string" },
        "server_major_ver": { "type": "string" },
        "server_minor_ver": { "type": "string" }
      }
    },
    "setting": {
      "type": "object",
      "additionalProperties": false,
      "required": ["setting", "unit", "category", "context", "vartype", "pretty_value"],
      "properties": {
        "setting": { "type": "string" },
        "unit": { "type": "string" },
        "category": { "type": "string" },
        "context": { "type": "string" },
        "vartype": { "type": "string" },
        "pretty_value": { "type": "string" }
      }
    },
    "pgssSampleQuery": {
      "type": "object",
      "additionalProperties": false,
      "required": ["queryid", "user", "database", "calls"],
      "properties": {
        "queryid": { "type": "string" },
        "user": { "type": "string" },
        "database": { "type": "string" },
        "calls": { "type": "number" }
      }
    },
    "pgssStatus": {
      "type": "object",
      "additionalProperties": false,
      "required": ["extension_available", "metrics_count", "total_calls", "sample_queries"],
      "properties": {
        "extension_available": { "type": "boolean" },
        "metrics_count": { "type": "number" },
        "total_calls": { "type": "number" },
        "sample_queries": { "type": "array", "items": { "$ref": "#/$defs/pgssSampleQuery" } }
      }
    },
    "kcacheSampleQuery": {
      "type": "object",
      "additionalProperties": false,
      "required": ["queryid", "user", "exec_total_time"],
      "properties": {
        "queryid": { "type": "string" },
        "user": { "type": "string" },
        "exec_total_time": { "type": "number" }
      }
    },
    "kcacheStatus": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "extension_available",
        "metrics_count",
        "total_exec_time",
        "total_user_time",
        "total_system_time",
        "sample_queries"
      ],
      "properties": {
        "extension_available": { "type": "boolean" },
        "metrics_count": { "type": "number" },
        "total_exec_time": { "type": "number" },
        "total_user_time": { "type": "number" },
        "total_system_time": { "type": "number" },
        "sample_queries": { "type": "array", "items": { "$ref": "#/$defs/kcacheSampleQuery" } }
      }
    },
    "data": {
      "type": "object",
      "additionalProperties": false,
      "required": ["settings", "pg_stat_statements_status", "pg_stat_kcache_status"],
      "properties": {
        "settings": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/setting" }
        },
        "pg_stat_statements_status": { "$ref": "#/$defs/pgssStatus" },
        "pg_stat_kcache_status": { "$ref": "#/$defs/kcacheStatus" }
      }
    },
    "nodeResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["data"],
      "properties": {
        "data": { "$ref": "#/$defs/data" },
        "postgres_version": { "$ref": "#/$defs/postgresVersion" }
      }
    }
  }
}


