{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "H001 report schema",
  "type": "object",
  "additionalProperties": false,
  "required": ["checkId", "checkTitle", "timestamptz", "nodes", "results"],
  "properties": {
    "version": { "type": ["string", "null"] },
    "build_ts": { "type": ["string", "null"] },
    "generation_mode": { "type": ["string", "null"] },
    "checkId": { "const": "H001" },
    "checkTitle": { "const": "Invalid indexes" },
    "timestamptz": { "type": "string" },
    "nodes": { "$ref": "#/$defs/nodes" },
    "results": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": { "$ref": "#/$defs/nodeResult" }
    }
  },
  "$defs": {
    "nodes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["primary", "standbys"],
      "properties": {
        "primary": { "type": "string" },
        "standbys": { "type": "array", "items": { "type": "string" } }
      }
    },
    "postgresVersion": {
      "type": "object",
      "additionalProperties": false,
      "required": ["version", "server_version_num", "server_major_ver", "server_minor_ver"],
      "properties": {
        "version": { "type": "string" },
        "server_version_num": { "type": "string" },
        "server_major_ver": { "type": "string" },
        "server_minor_ver": { "type": "string" }
      }
    },
    "recommendation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["action", "reason", "sql_commands"],
      "properties": {
        "action": {
          "type": "string",
          "enum": ["drop", "recreate", "investigate"],
          "description": "Recommended action: drop (safe to remove), recreate (REINDEX CONCURRENTLY), or investigate (needs RCA)"
        },
        "reason": {
          "type": "string",
          "description": "Explanation of why this action is recommended"
        },
        "sql_commands": {
          "type": "array",
          "items": { "type": "string" },
          "description": "SQL commands to execute (always use CONCURRENTLY variants)"
        }
      }
    },
    "invalidIndex": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "schema_name",
        "table_name",
        "index_name",
        "relation_name",
        "index_size_bytes",
        "index_size_pretty",
        "index_definition",
        "supports_fk",
        "has_valid_index_on_same_columns",
        "backs_constraint",
        "constraint_name",
        "table_row_count_estimate",
        "recommendation"
      ],
      "properties": {
        "schema_name": { "type": "string" },
        "table_name": { "type": "string" },
        "index_name": { "type": "string" },
        "relation_name": { "type": "string" },
        "index_size_bytes": { "type": "number" },
        "index_size_pretty": { "type": "string" },
        "index_definition": { "type": "string", "description": "Full CREATE INDEX statement from pg_get_indexdef(), useful for DROP/CREATE migrations" },
        "supports_fk": { "type": "boolean" },
        "has_valid_index_on_same_columns": {
          "type": "boolean",
          "description": "True if a valid index exists on the same columns (duplicate invalid index)"
        },
        "backs_constraint": {
          "type": "boolean",
          "description": "True if this index backs a UNIQUE or PRIMARY KEY constraint"
        },
        "constraint_name": {
          "type": ["string", "null"],
          "description": "Name of the constraint this index backs, or null if none"
        },
        "table_row_count_estimate": {
          "type": "integer",
          "description": "Estimated row count for the table (from pg_class.reltuples)"
        },
        "recommendation": { "$ref": "#/$defs/recommendation" }
      }
    },
    "dbEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "invalid_indexes",
        "total_count",
        "total_size_bytes",
        "total_size_pretty",
        "database_size_bytes",
        "database_size_pretty"
      ],
      "properties": {
        "invalid_indexes": { "type": "array", "items": { "$ref": "#/$defs/invalidIndex" } },
        "total_count": { "type": "integer" },
        "total_size_bytes": { "type": "number" },
        "total_size_pretty": { "type": "string" },
        "database_size_bytes": { "type": "number" },
        "database_size_pretty": { "type": "string" }
      }
    },
    "data": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/dbEntry" }
    },
    "nodeResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["data"],
      "properties": {
        "data": { "$ref": "#/$defs/data" },
        "postgres_version": { "$ref": "#/$defs/postgresVersion" }
      }
    }
  }
}


